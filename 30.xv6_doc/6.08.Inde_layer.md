## inode layer

inode라는 용어는 두 가지 관련 의미 중 하나를 가질 수 있습니다.

* 디스크에 존재하는 inode : inode block
* 커널에 존재하는 inode 

파일의 크기와 데이터 블록 번호 목록을 포함하는 온디스크 데이터 구조를 참조할 수 있습니다. 또는 'inode''는 디스크에 있는 inode의 복사본과 커널 내에서 필요한 추가 정보를 포함하는 메모리 내 inode를 나타낼 수 있습니다.

#### inode block

디스크에 있는 모든 inode는 inode 블록이라고 하는 디스크의 인접 영역에 패킹됩니다. 모든 inode는 크기가 동일하므로 숫자 n이 주어지면 디스크에서 n번째 inode를 찾는 것이 쉽습니다. 사실, inode 번호 또는 i-number라고 하는 이 숫자 n은 구현에서 inode를 식별하는 방법입니다.

디스크 상의 inode는 struct dinode(3926)에 의해 정의됩니다. 유형 필드는 파일, 디렉토리 및 특수 파일(장치)을 구분합니다.

0 유형은 디스크에 있는 inode가 비어 있음을 나타냅니다. nlink 필드는 디스크에 있는 inode와 데이터 블록을 해제해야 하는 시기를 인식하기 위해 이 inode를 참조하는 디렉토리 항목의 수를 계산합니다. 크기 필드는 파일의 콘텐츠 바이트 수를 기록합니다. addrs 배열은 파일의 내용을 담고 있는 디스크 블록의 블록 번호를 기록합니다.

#### struct inode

커널은 메모리에 활성 inode 세트를 유지합니다. struct inode(4012)는 디스크에 있는 struct dinode의 메모리 내 복사본입니다. 커널은 해당 inode를 참조하는 C 포인터가 있는 경우에만 메모리에 inode를 저장합니다. ref 필드는 메모리 내 inode를 참조하는 C 포인터의 수를 계산하고 참조 카운트가 0으로 떨어지면 커널은 메모리에서 inode를 버립니다.

#### iget, iput

iget 및 iput 함수는 참조 횟수를 수정하여 inode에 대한 포인터를 획득 및 해제합니다. inode에 대한 포인터는 파일 설명자, 현재 작업 디렉토리, exec와 같은 임시 커널 코드에서 가져올 수 있습니다.

iget()에 의해 반환된 포인터는 iput()에 대한 해당 호출까지 유효하다는 것이 보장됩니다. inode는 삭제되지 않으며 포인터가 참조하는 메모리는 다른 inode에 재사용되지 않습니다.
iget()은 동일한 inode에 대한 많은 포인터가 있을 수 있도록 inode에 대한 비독점적 액세스를 제공합니다. 파일 시스템 코드의 많은 부분이 iget()의 이러한 동작에 의존하여 inode(열린 파일 및 현재 디렉토리)에 대한 장기 참조를 유지하고 여러 inode(경로 이름 등)를 조작하는 코드에서 교착 상태를 피하면서 경합을 방지합니다. 조회).

iget이 반환하는 struct inode에는 유용한 콘텐츠가 없을 수 있습니다. 디스크에 있는 inode의 복사본을 유지하려면 코드에서 ilock을 호출해야 합니다. 이것은 다른 프로세스가 ilock할 수 없도록 inode를 잠그고 아직 읽지 않은 경우 디스크에서 inode를 읽습니다.

iunlock은 inode에 대한 잠금을 해제합니다. 잠금에서 inode 포인터 획득을 분리하면 디렉터리 조회와 같은 일부 상황에서 교착 상태를 방지하는 데 도움이 됩니다.

여러 프로세스가 iget에서 반환된 inode에 대한 C 포인터를 보유할 수 있지만 한 번에 하나의 프로세스만 inode를 잠글 수 있습니다.

inode 캐시는 커널 코드 또는 데이터 구조가 C 포인터를 보유하는 inode만 캐시합니다. 주요 작업은 실제로 캐싱이 아닌 여러 프로세스의 액세스를 동기화하는 것입니다. inode가 자주 사용되는 경우 버퍼 캐시는 inode 캐시에 의해 보관되지 않는 경우 메모리에 보관할 것입니다.