### File Descriptor layer

Unix 인터페이스의 멋진 측면 중 하나는 콘솔, 파이프 및 물론 실제 파일과 같은 장치를 포함하여 Unix의 대부분의 리소스가 파일로 표시된다는 것입니다. 파일 디스크립터 레이어는 이러한 균일성을 달성하는 레이어입니다.

Xv6은 0장에서 본 것처럼 각 프로세스에 고유한 열린 파일 테이블 또는 파일 디스크립터를 제공합니다. 각 열린 파일은 구조체 파일(4000)로 표시됩니다. /o 오프셋.
open을 호출할 때마다 새 열린 파일(새 구조체 파일)이 생성됩니다. 여러 프로세스가 동일한 파일을 독립적으로 여는 경우 다른 인스턴스는 다른 i/o 오프셋을 갖습니다. 반면에 하나의 열린 파일(동일한 구조 파일)은 한 프로세스의 파일 테이블과 여러 프로세스의 파일 테이블에 여러 번 나타날 수 있습니다.
이것은 한 프로세스가 파일을 여는 데 사용한 다음 dup을 사용하여 별칭을 만들거나 포크를 사용하여 자식과 공유한 경우에 발생합니다.
참조 카운트는 특정 열려 있는 파일에 대한 참조 수를 추적합니다. 읽기나 쓰기 또는 둘 다용으로 파일을 열 수 있습니다. 읽기 및 쓰기 가능한 필드가 이를 추적합니다.
시스템에서 열려 있는 모든 파일은 전역 파일 테이블인 ftable에 보관됩니다. 파일 테이블에는 파일 할당(filealloc), 중복 참조 생성(filedup), 참조 해제(fileclose), 데이터 읽기 및 쓰기(fileread 및 filewrite) 기능이 있습니다.
처음 세 개는 이제 친숙한 형식을 따릅니다. Filealloc(5625)은 참조되지 않은 파일(f->ref == 0)에 대해 파일 테이블을 검색하고 새 참조를 반환합니다. 파일업(5652)은 참조 카운트를 증가시킵니다. fileclose(5664)는 이를 감소시킵니다. 파일의 참조 횟수가 0에 도달하면 fileclose는 유형에 따라 기본 파이프 또는 inode를 해제합니다.

filestat, fileread 및 filewrite 함수는 파일에 대한 stat, 읽기 및 쓰기 작업을 구현합니다. Filestat(5702)는 inode에서만 허용되며 stati를 호출합니다.
파일 읽기 및 파일 쓰기는 작업이 개방 모드에서 허용되는지 확인한 다음 파이프 또는 inode 구현으로 호출을 전달합니다. 파일이 inode를 나타내는 경우 fileread 및 filewrite는 i/o 오프셋을 작업의 오프셋으로 사용한 다음 이를 진행합니다(5725-5726, 5765-5766). 파이프에는 오프셋 개념이 없습니다.

inode 함수는 호출자가 잠금을 처리해야 함을 기억하십시오(5705-5707, 5724-5727, 5764-5778). inode 잠금은 읽기 및 쓰기 오프셋이 원자적으로 업데이트되므로 쓰기가 인터레이스로 끝날 수 있지만 동일한 파일에 동시에 여러 번 쓰기가 서로의 데이터를 덮어쓸 수 없다는 편리한 부작용이 있습니다.