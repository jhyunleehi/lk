## Porcess 확인



### 1. ps 명령

* OS: raspberrypi 
* cpu:  armv7 기반 Cortex-A9 

```sh
pi@raspberrypi:~ $ uname -a
Linux raspberrypi 4.4.0 #2 SMP Tue May 17 22:32:58 KST 2022 armv7l GNU/Linux

pi@raspberrypi:~ $ cat /etc/os-release
PRETTY_NAME="Raspbian GNU/Linux 10 (buster)"
NAME="Raspbian GNU/Linux"
VERSION_ID="10"
VERSION="10 (buster)"
VERSION_CODENAME=buster
ID=raspbian
ID_LIKE=debian
HOME_URL="http://www.raspbian.org/"
SUPPORT_URL="http://www.raspbian.org/RaspbianForums"
BUG_REPORT_URL="http://www.raspbian.org/RaspbianBugs"

pi@raspberrypi:~ $ lscpu
Architecture:         armv7l
Byte Order:           Little Endian
CPU(s):               4
On-line CPU(s) list:  0
Off-line CPU(s) list: 1-3
Thread(s) per core:   1
Core(s) per socket:   1
Socket(s):            1
Vendor ID:            ARM
Model:                0
Model name:           Cortex-A9
Stepping:             r0p0
BogoMIPS:             709.42
Flags:                half thumb fastmult vfp edsp neon vfpv3 tls vfpd32

```



```sh
pi@raspberrypi:~ $ ps -ely
S   UID   PID  PPID  C PRI  NI   RSS    SZ WCHAN  TTY          TIME CMD
S     0     1     0  0  80   0  7852  8400 -      ?        00:00:18 systemd  <<----- 이것이 init 시스템과 프로세스이다.
S     0     2     0  0  80   0     0     0 -      ?        00:00:00 kthreadd <<-------
S     0     3     2  0  80   0     0     0 -      ?        00:00:00 ksoftirqd/0
S     0     5     2  0  60 -20     0     0 -      ?        00:00:00 kworker/0:0H
S     0     7     2  0  80   0     0     0 -      ?        00:00:04 rcu_sched
S     0     8     2  0  80   0     0     0 -      ?        00:00:00 rcu_bh
S     0     9     2  0 -40   -     0     0 -      ?        00:00:07 migration/0
S     0    10     2  0 -40   -     0     0 -      ?        00:00:00 migration/1
S     0    11     2  0  80   0     0     0 -      ?        00:00:00 ksoftirqd/1
S     0    12     2  0  80   0     0     0 -      ?        00:00:00 kworker/1:0
S     0    13     2  0  60 -20     0     0 -      ?        00:00:00 kworker/1:0H
S     0    14     2  0 -40   -     0     0 -      ?        00:00:00 migration/2
S     0    15     2  0  80   0     0     0 -      ?        00:00:00 ksoftirqd/2
S     0    16     2  0  80   0     0     0 -      ?        00:00:00 kworker/2:0
S     0    17     2  0  60 -20     0     0 -      ?        00:00:00 kworker/2:0H
S     0    18     2  0 -40   -     0     0 -      ?        00:00:00 migration/3
S     0    19     2  0  80   0     0     0 -      ?        00:00:00 ksoftirqd/3
S     0    20     2  0  80   0     0     0 -      ?        00:00:00 kworker/3:0
S     0    21     2  0  60 -20     0     0 -      ?        00:00:00 kworker/3:0H
S     0    22     2  0  80   0     0     0 -      ?        00:00:00 kdevtmpfs
S     0    29     2  0  60 -20     0     0 -      ?        00:00:00 perf
S     0   173     2  0  80   0     0     0 -      ?        00:00:00 khungtaskd
S     0   288     2  0  60 -20     0     0 -      ?        00:00:00 writeback
S     0   290     2  0  60 -20     0     0 -      ?        00:00:00 crypto
S     0   291     2  0  60 -20     0     0 -      ?        00:00:00 bioset
S     0   293     2  0  60 -20     0     0 -      ?        00:00:00 kblockd
S     0   301     2  0  60 -20     0     0 -      ?        00:00:00 ata_sff
S     0   415     2  0  60 -20     0     0 -      ?        00:00:00 rpciod
S     0   432     2  0  80   0     0     0 -      ?        00:00:00 kswapd0
S     0   433     2  0  60 -20     0     0 -      ?        00:00:00 vmstat
S     0   438     2  0  80   0     0     0 -      ?        00:00:00 fsnotify_mark
S     0   496     2  0  60 -20     0     0 -      ?        00:00:00 nfsiod
S     0   566     2  0  60 -20     0     0 -      ?        00:00:00 bioset
S     0   581     2  0  60 -20     0     0 -      ?        00:00:00 bioset
S     0   587     2  0  60 -20     0     0 -      ?        00:00:00 bioset
S     0   608     2  0  60 -20     0     0 -      ?        00:00:00 kpsmoused
S     0  1728     2  0  60 -20     0     0 -      ?        00:00:00 deferwq
S     0  1731     2  0  60 -20     0     0 -      ?        00:00:00 kworker/0:1H
S     0  1732     2  0  80   0     0     0 -      ?        00:00:00 jbd2/vda2-8
S     0  1733     2  0  60 -20     0     0 -      ?        00:00:00 ext4-rsv-conver
```



#### pid

/mnt/code/vexpress/linux/include/linux/types.h

```c
typedef __kernel_fd_set		fd_set;
typedef __kernel_dev_t		dev_t;
typedef __kernel_ino_t		ino_t;
typedef __kernel_mode_t		mode_t;
typedef unsigned short		umode_t;
typedef __u32			nlink_t;
typedef __kernel_off_t		off_t;
typedef __kernel_pid_t		pid_t; <<--- 
typedef __kernel_daddr_t	daddr_t;
typedef __kernel_key_t		key_t;
typedef __kernel_suseconds_t	suseconds_t;
typedef __kernel_timer_t	timer_t;
typedef __kernel_clockid_t	clockid_t;
typedef __kernel_mqd_t		mqd_t;
```



/usr/include/asm-generic/posix_types.h

```c
#ifndef __kernel_pid_t
typedef int		__kernel_pid_t;
#endif
```



#### getpid() 함수 분석

/mnt/code/vexpress/linux/kernel/sys.c

```c
SYSCALL_DEFINE0(getpid)
{
	return task_tgid_vnr(current);
}
```

* pid_vnr은 inline 함수로 되어 있음

/mnt/code/vexpress/linux/include/linux/sched.h

```c
static inline pid_t task_tgid_vnr(struct task_struct *tsk)
{
	return pid_vnr(task_tgid(tsk));
}

static inline struct pid *task_tgid(struct task_struct *task)
{
	return task->group_leader->pids[PIDTYPE_PID].pid;
}

===>> struct task_struct
    
struct task_struct {
	volatile long state;	/* -1 unrunnable, 0 runnable, >0 stopped */
	void *stack;
	atomic_t usage;
	unsigned int flags;	/* per process flags, defined below */
	unsigned int ptrace;
    ...
```

* 나머지는 매크로

```c

#define SYSCALL_DEFINE0(sname)					\
	SYSCALL_METADATA(_##sname, 0);				\
	asmlinkage long sys_##sname(void)
-------
#define SYSCALL_METADATA(sname, nb, ...)			\
	static const char *types_##sname[] = {			\
		__MAP(nb,__SC_STR_TDECL,__VA_ARGS__)		\
	};							\
	static const char *args_##sname[] = {			\
		__MAP(nb,__SC_STR_ADECL,__VA_ARGS__)		\
	};							\
	SYSCALL_TRACE_ENTER_EVENT(sname);			\
	SYSCALL_TRACE_EXIT_EVENT(sname);			\
	static struct syscall_metadata __used			\
	  __syscall_meta_##sname = {				\
		.name 		= "sys"#sname,			\
		.syscall_nr	= -1,	/* Filled in at boot */	\
		.nb_args 	= nb,				\
		.types		= nb ? types_##sname : NULL,	\
		.args		= nb ? args_##sname : NULL,	\
		.enter_event	= &event_enter_##sname,		\
		.exit_event	= &event_exit_##sname,		\
		.enter_fields	= LIST_HEAD_INIT(__syscall_meta_##sname.enter_fields), \
	};							\
	static struct syscall_metadata __used			\
	  __attribute__((section("__syscalls_metadata")))	\
	 *__p_syscall_meta_##sname = &__syscall_meta_##sname;
```





