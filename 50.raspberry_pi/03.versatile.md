# Versatile 

## kernel source 

downloaded qemu and linux from github. 
* qemu : https://github.com/qemu/qemu.git
* linux : https://github.com/torvalds/linux.git

### download 
```
~/code/versatile$ git clone --depth --tag v4.19  https://github.com/torvalds/linux.git
```

### compiile
체 
컴파일 할때 initrd 이미지 까지 함께 만들어서 booting할때 사용한다. 

```
#!/bin/sh
export PATH=/opt/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-
export TOOLCHAIN=arm-linux-gnueabihf
export KERNEL_MAKE_CONFIG=menuconfig
KERNEL=kernel7
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- versatile_defconfig
cat >> .config << EOF
CONFIG_CROSS_COMPILE="$TOOLCHAIN"
EOF
make  ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- $KERNEL_MAKE_CONFIG
make  ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bzImage modules dtbs  -j8
mkinitramfs -o arch/arm/boot/initrd.img

cp  arch/arm/boot/zImage ~/code/versatile/kernel-4.19.versatilepb.img
cp  arch/arm/boot/dts/versatile-pb.dtb  ~/code/versatile
```
### menuconfig
```
Boot options
-*- Flattened Device Tree support            │  
[*]   Support for the traditional ATAGS boot data passing         
[ ]     Provide old way to pass kernel parameters                 
(0x0) Compressed ROM boot loader base address│  
(0x0) Compressed ROM boot loader BSS address │  
[*] Use appended device tree blob to zImage (EXPERIMENTAL)        
[*]   Supplement the appended DTB with traditional ATAG information                   
        Kernel command line type (Use bootloader kernel arguments if available)  ---> 
   
Kernel Hacking : source Disassembling
[*] Compile the kernel with debug info 
[*]   Generate dwarf4 debuginfo                           
[*]   Provide GDB scripts for kernel debugging            
[*] Enable __deprecated logic                             
[*] Enable __must_check logic                             
(1024) Warn for stack frames larger than (needs gcc 4.4)  
[*] Strip assembler-generated symbols during link         
[*] Generate readable assembler code  
```
### OS image 
```
$ fdisk -l 2020-02-13-raspbian-buster.img
Disk 2020-02-13-raspbian-buster.img: 3.5 GiB, 3787456512 bytes, 7397376 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xea7d04d6

Device                          Boot  Start     End Sectors  Size Id Type
2020-02-13-raspbian-buster.img1        8192  532479  524288  256M  c W95 FAT32 (LBA)
2020-02-13-raspbian-buster.img2      532480 7397375 6864896  3.3G 83 Linux
```

### busybox
I downloaded busybox and i followed some steps.
```
wget http://www.busybox.net/downloads/busybox-1.24.1.tar.bz2
tar -xvf busybox-1.24.1.tar.bz2
cd busybox-1.24.1/
make defconfig
make menuconfig (to make binary as static not shared)
make -j8
make install
cd _install
find . | cpio -o --format=newc > ../rootfs.img
cd ..
gzip -c rootfs.img > rootfs.img.gz
```

### qemu-system-arm 
```
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-

qemu-system-arm  \
  -M      versatilepb \
  -kernel linux/arch/arm/boot/zImage \
  -nographic \
  -dtb    linux/arch/arm/boot/dts/versatile-pb.dtb  \
  -initrd kernel-qemu-4.19.50-buster \
  -append "root=/dev/ram0 initrd=/bin/sh"
```  


qemu-system-arm -M versatilepb -kernel ./arch/arm/boot/zImage -nographic -dtb arch/arm/boot/dts/versatile-pb.dtb -initrd ../rootfs.img.gz -append "root=/dev/ram0 initrd=/bin/sh"

### case 1

```
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-

qemu-system-arm  \
  -M      versatilepb \
  -kernel linux/arch/arm/boot/zImage \
  -nographic \
  -dtb    linux/arch/arm/boot/dts/versatile-pb.dtb  \
  -hda    rootfs.img.gz \
  -append 'root=/dev/sda2 panic=1' \
  -no-reboot 

<log>

VFS: Cannot open root device "sda2" or unknown-block(0,0): error -6
Please append a correct "root=" boot option; here are the available partitions:
Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)
CPU: 0 PID: 1 Comm: swapper Not tainted 4.19.0 #2
Hardware name: ARM-Versatile (Device Tree Support)
[<c001c7f4>] (unwind_backtrace) from [<c001949c>] (show_stack+0x10/0x14)
[<c001949c>] (show_stack) from [<c0024ee4>] (panic+0xc8/0x248)
[<c0024ee4>] (panic) from [<c050c1e4>] (mount_block_root+0x1b4/0x2b0)
[<c050c1e4>] (mount_block_root) from [<c050c54c>] (mount_root+0x118/0x15c)
[<c050c54c>] (mount_root) from [<c050c6f0>] (prepare_namespace+0x160/0x1b4)
[<c050c6f0>] (prepare_namespace) from [<c050be50>] (kernel_init_freeable+0x188/0x1d0)
[<c050be50>] (kernel_init_freeable) from [<c03e6f78>] (kernel_init+0x8/0xf4)
[<c03e6f78>] (kernel_init) from [<c00090e0>] (ret_from_fork+0x14/0x34)
Exception stack(0xc781ffb0 to 0xc781fff8)
ffa0:                                     00000000 00000000 00000000 00000000
ffc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
ffe0: 00000000 00000000 00000000 00000000 00000013 00000000
Rebooting in 1 seconds..
```


### case 2
```
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-

qemu-system-arm  \
  -M      versatilepb \
  -kernel linux/arch/arm/boot/zImage \
  -nographic \
  -dtb    linux/arch/arm/boot/dts/versatile-pb.dtb  \
  -hda    kernel-qemu-4.19.50-buster \
  -append 'root=/dev/sda2 panic=1' \
  -no-reboot


<log>
VFS: Cannot open root device "sda2" or unknown-block(0,0): error -6
Please append a correct "root=" boot option; here are the available partitions:
VFS: Cannot open root device "sda2" or unknown-block(0,0): error -6
Please append a correct "root=" boot option; here are the available partitions:
0100            4096 ram0  (driver?)
0101            4096 ram1  (driver?)
0102            4096 ram2  (driver?)
0103            4096 ram3  (driver?)
0104            4096 ram4  (driver?)
0105            4096 ram5  (driver?)
0106            4096 ram6  (driver?)
0107            4096 ram7  (driver?)
0108            4096 ram8  (driver?)
0109            4096 ram9  (driver?)
010a            4096 ram10  (driver?)
010b            4096 ram11  (driver?)
010c            4096 ram12  (driver?)
010d            4096 ram13   (driver?)
010e            4096 ram14  (driver?)
010f            4096 ram15  (driver?)
1f00           65536 mtdblock0  (driver?)

Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)
CPU: 0 PID: 1 Comm: swapper Not tainted 4.19.0 #2
Hardware name: ARM-Versatile (Device Tree Support)
[<c001c7f4>] (unwind_backtrace) from [<c001949c>] (show_stack+0x10/0x14)
[<c001949c>] (show_stack) from [<c0024ee4>] (panic+0xc8/0x248)
[<c0024ee4>] (panic) from [<c050c1e4>] (mount_block_root+0x1b4/0x2b0)
[<c050c1e4>] (mount_block_root) from [<c050c54c>] (mount_root+0x118/0x15c)
[<c050c54c>] (mount_root) from [<c050c6f0>] (prepare_namespace+0x160/0x1b4)
[<c050c6f0>] (prepare_namespace) from [<c050be50>] (kernel_init_freeable+0x188/0x1d0)
[<c050be50>] (kernel_init_freeable) from [<c03e6f78>] (kernel_init+0x8/0xf4)
[<c03e6f78>] (kernel_init) from [<c00090e0>] (ret_from_fork+0x14/0x34)
Exception stack(0xc781ffb0 to 0xc781fff8)
ffa0:                                     00000000 00000000 00000000 00000000
ffc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
ffe0: 00000000 00000000 00000000 00000000 00000013 00000000
Rebooting in 1 seconds..
Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)
CPU: 0 PID: 1 Comm: swapper Not tainted 4.19.0 #2
Hardware name: ARM-Versatile (Device Tree Support)
[<c001c7f4>] (unwind_backtrace) from [<c001949c>] (show_stack+0x10/0x14)
[<c001949c>] (show_stack) from [<c0024ee4>] (panic+0xc8/0x248)
[<c0024ee4>] (panic) from [<c050c1e4>] (mount_block_root+0x1b4/0x2b0)
[<c050c1e4>] (mount_block_root) from [<c050c54c>] (mount_root+0x118/0x15c)
[<c050c54c>] (mount_root) from [<c050c6f0>] (prepare_namespace+0x160/0x1b4)
[<c050c6f0>] (prepare_namespace) from [<c050be50>] (kernel_init_freeable+0x188/0x1d0)
[<c050be50>] (kernel_init_freeable) from [<c03e6f78>] (kernel_init+0x8/0xf4)
[<c03e6f78>] (kernel_init) from [<c00090e0>] (ret_from_fork+0x14/0x34)
Exception stack(0xc781ffb0 to 0xc781fff8)
ffa0:                                     00000000 00000000 00000000 00000000
ffc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
ffe0: 00000000 00000000 00000000 00000000 00000013 00000000
Rebooting in 1 seconds..
```


### case 3
```
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-

qemu-system-arm \
  -M versatilepb \
  -cpu arm1176 \
  -m 256 \
  -hda    kernel-qemu-4.19.50-buster  \
  -dtb    linux/arch/arm/boot/dts/versatile-pb.dtb \
  -kernel linux/arch/arm/boot/zImage   \
  -append 'root=/dev/sda2 panic=1' \
  -no-reboot \
  -nographic

<log>
$ sh r3.sh
VFS: Cannot open root device "sda2" or unknown-block(0,0): error -19
Please append a correct "root=" boot option; here are the available partitions:
0100            4096 ram0  (driver?)
0101            4096 ram1  (driver?)
0102            4096 ram2  (driver?)
0103            4096 ram3  (driver?)
0104            4096 ram4  (driver?)
0105            4096 ram5  (driver?)
0106            4096 ram6  (driver?)
0107            4096 ram7  (driver?)
0108            4096 ram8  (driver?)
0109            4096 ram9  (driver?)
010a            4096 ram10 (driver?)
010b            4096 ram11  (driver?)
010c            4096 ram12  (driver?)
010d            4096 ram13  (driver?)
010e            4096 ram14  (driver?)
010f            4096 ram15  (driver?)
1f00           65536 mtdblock0  (driver?)
Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)
CPU: 0 PID: 1 Comm: swapper Not tainted 4.19.0 #2
Hardware name: ARM-Versatile (Device Tree Support)
[<c001c7f4>] (unwind_backtrace) from [<c001949c>] (show_stack+0x10/0x14)
[<c001949c>] (show_stack) from [<c0024ee4>] (panic+0xc8/0x248)
[<c0024ee4>] (panic) from [<c050c1e4>] (mount_block_root+0x1b4/0x2b0)
[<c050c1e4>] (mount_block_root) from [<c050c54c>] (mount_root+0x118/0x15c)
[<c050c54c>] (mount_root) from [<c050c6f0>] (prepare_namespace+0x160/0x1b4)
[<c050c6f0>] (prepare_namespace) from [<c050be50>] (kernel_init_freeable+0x188/0x1d0)
[<c050be50>] (kernel_init_freeable) from [<c03e6f78>] (kernel_init+0x8/0xf4)
[<c03e6f78>] (kernel_init) from [<c00090e0>] (ret_from_fork+0x14/0x34)
Exception stack(0xcf821fb0 to 0xcf821ff8)
1fa0:                                     00000000 00000000 00000000 00000000
1fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
1fe0: 00000000 00000000 00000000 00000000 00000013 00000000
Rebooting in 1 seconds..



```


### case 4
```
pulseaudio: set_sink_input_volume() failed
pulseaudio: Reason: Invalid argument
pulseaudio: set_sink_input_mute() failed
pulseaudio: Reason: Invalid argument
vpb_sic_write: Bad register offset 0x2c
Booting Linux on physical CPU 0x0
Linux version 4.19.0 (good@good-VirtualBox) (gcc version 4.9.3 (crosstool-NG crosstool-ng-1.22.0-88-g8460611)) #2 Sun Jul 26 20:18:41 KST 2020
CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=00093177
CPU: VIVT data cache, VIVT instruction cache
OF: fdt: Machine model: ARM Versatile PB
Memory policy: Data cache writeback
random: get_random_bytes called from start_kernel+0x7c/0x3e8 with crng_init=0
Built 1 zonelists, mobility grouping on.  Total pages: 32512
Kernel command line: root=/dev/ram0 rootfstype=ext4 rw  panic=1
Dentry cache hash table entries: 16384 (order: 4, 65536 bytes)
Inode-cache hash table entries: 8192 (order: 3, 32768 bytes)
Memory: 83676K/131072K available (3980K kernel code, 148K rwdata, 1008K rodata, 180K init, 131K bss, 47396K reserved, 0K cma-reserved)
Virtual kernel memory layout:
    vector  : 0xffff0000 - 0xffff1000   (   4 kB)
    fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
    vmalloc : 0xc8800000 - 0xff800000   ( 880 MB)
    lowmem  : 0xc0000000 - 0xc8000000   ( 128 MB)
    modules : 0xbf000000 - 0xc0000000   (  16 MB)
      .text : 0x(ptrval) - 0x(ptrval)   (3982 kB)
      .init : 0x(ptrval) - 0x(ptrval)   ( 180 kB)
      .data : 0x(ptrval) - 0x(ptrval)   ( 149 kB)
       .bss : 0x(ptrval) - 0x(ptrval)   ( 132 kB)
NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16
VIC @(ptrval): id 0x00041190, vendor 0x41
FPGA IRQ chip 0 "intc" @ (ptrval), 20 irqs, parent IRQ: 47
clocksource: arm,sp804: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 1911260446275 ns
sched_clock: 32 bits at 1000kHz, resolution 1000ns, wraps every 2147483647500ns
Failed to initialize '/amba/timer@101e3000': -22
sched_clock: 32 bits at 24MHz, resolution 41ns, wraps every 89478484971ns
Console: colour dummy device 80x30
console [tty0] enabled
Calibrating delay loop... 484.14 BogoMIPS (lpj=2420736)
pid_max: default: 32768 minimum: 301
Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
CPU: Testing write buffer coherency: ok
Setting up static identity map for 0x8400 - 0x8458
VFP support v0.3: implementor 41 architecture 1 part 10 variant 9 rev 0
clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
futex hash table entries: 256 (order: -1, 3072 bytes)
NET: Registered protocol family 16
DMA: preallocated 256 KiB pool for atomic coherent allocations
OF: amba_device_add() failed (-19) for /amba/smc@10100000
OF: amba_device_add() failed (-19) for /amba/mpmc@10110000
OF: amba_device_add() failed (-19) for /amba/sctl@101e0000
OF: amba_device_add() failed (-19) for /amba/watchdog@101e1000
OF: amba_device_add() failed (-19) for /amba/sci@101f0000
OF: amba_device_add() failed (-19) for /amba/ssp@101f4000
OF: amba_device_add() failed (-19) for /amba/fpga/sci@a000
Serial: AMBA PL011 UART driver
101f1000.uart: ttyAMA0 at MMIO 0x101f1000 (irq = 28, base_baud = 0) is a PL011 rev1
console [ttyAMA0] enabled
101f2000.uart: ttyAMA1 at MMIO 0x101f2000 (irq = 29, base_baud = 0) is a PL011 rev1
101f3000.uart: ttyAMA2 at MMIO 0x101f3000 (irq = 30, base_baud = 0) is a PL011 rev1
uart-pl011 10009000.uart: aliased and non-aliased serial devices found in device tree. Serial port enumeration may be unpredictable.
10009000.uart: ttyAMA3 at MMIO 0x10009000 (irq = 54, base_baud = 0) is a PL011 rev1
clocksource: Switched to clocksource arm,sp804
NET: Registered protocol family 2
tcp_listen_portaddr_hash hash table entries: 512 (order: 0, 4096 bytes)
TCP established hash table entries: 1024 (order: 0, 4096 bytes)
TCP bind hash table entries: 1024 (order: 0, 4096 bytes)
TCP: Hash tables configured (established 1024 bind 1024)
UDP hash table entries: 256 (order: 0, 4096 bytes)
UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)
NET: Registered protocol family 1
RPC: Registered named UNIX socket transport module.
RPC: Registered udp transport module.
RPC: Registered tcp transport module.
RPC: Registered tcp NFSv4.1 backchannel transport module.
Trying to unpack rootfs image as initramfs...
random: fast init done
swapper invoked oom-killer: gfp_mask=0x6200c2(GFP_HIGHUSER), nodemask=(null), order=0, oom_score_adj=0
CPU: 0 PID: 1 Comm: swapper Not tainted 4.19.0 #2
Hardware name: ARM-Versatile (Device Tree Support)
[<c001c7f4>] (unwind_backtrace) from [<c001949c>] (show_stack+0x10/0x14)
[<c001949c>] (show_stack) from [<c0083c98>] (dump_header+0x60/0x1d8)
[<c0083c98>] (dump_header) from [<c0083b00>] (out_of_memory+0x3a8/0x460)
[<c0083b00>] (out_of_memory) from [<c00889c8>] (__alloc_pages_nodemask+0xaa8/0xc00)
[<c00889c8>] (__alloc_pages_nodemask) from [<c007fd00>] (pagecache_get_page+0x200/0x310)
[<c007fd00>] (pagecache_get_page) from [<c007fe28>] (grab_cache_page_write_begin+0x18/0x2c)
[<c007fe28>] (grab_cache_page_write_begin) from [<c00e9b40>] (simple_write_begin+0x1c/0x124)
[<c00e9b40>] (simple_write_begin) from [<c007f554>] (generic_perform_write+0xb8/0x1c8)
[<c007f554>] (generic_perform_write) from [<c0082224>] (__generic_file_write_iter+0x184/0x1e8)
[<c0082224>] (__generic_file_write_iter) from [<c00823a4>] (generic_file_write_iter+0x11c/0x214)
[<c00823a4>] (generic_file_write_iter) from [<c00c5e80>] (__vfs_write+0xf8/0x164)
[<c00c5e80>] (__vfs_write) from [<c00c6088>] (vfs_write+0xa0/0x178)
[<c00c6088>] (vfs_write) from [<c00c62c8>] (ksys_write+0x50/0xb8)
[<c00c62c8>] (ksys_write) from [<c050d888>] (xwrite+0x2c/0x68)
[<c050d888>] (xwrite) from [<c050db48>] (do_copy+0xb4/0x104)
[<c050db48>] (do_copy) from [<c050d494>] (write_buffer+0x2c/0x44)
[<c050d494>] (write_buffer) from [<c050d4e4>] (flush_buffer+0x38/0xa0)
[<c050d4e4>] (flush_buffer) from [<c0527d10>] (__gunzip+0x288/0x364)
[<c0527d10>] (__gunzip) from [<c0527e10>] (gunzip+0x24/0x2c)
[<c0527e10>] (gunzip) from [<c050e038>] (unpack_to_rootfs+0x16c/0x2b4)
[<c050e038>] (unpack_to_rootfs) from [<c050e1d4>] (populate_rootfs+0x54/0x118)
[<c050e1d4>] (populate_rootfs) from [<c000ac18>] (do_one_initcall+0x48/0x1a8)
[<c000ac18>] (do_one_initcall) from [<c050bdd0>] (kernel_init_freeable+0x108/0x1d0)
[<c050bdd0>] (kernel_init_freeable) from [<c03e6f78>] (kernel_init+0x8/0xf4)
[<c03e6f78>] (kernel_init) from [<c00090e0>] (ret_from_fork+0x14/0x34)
Exception stack(0xc781dfb0 to 0xc781dff8)
dfa0:                                     00000000 00000000 00000000 00000000
dfc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
dfe0: 00000000 00000000 00000000 00000000 00000013 00000000
Mem-Info:
active_anon:0 inactive_anon:0 isolated_anon:0
 active_file:0 inactive_file:0 isolated_file:0
 unevictable:20040 dirty:0 writeback:0 unstable:0
 slab_reclaimable:229 slab_unreclaimable:238
 mapped:0 shmem:0 pagetables:0 bounce:0
 free:289 free_pcp:2 free_cma:0
Node 0 active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:80160kB isolated(anon):0kB isolated(file):0kB mapped:0kB dirty:0kB writeback:0kB shmem:0kB writeback_tmp:0kB unstable:0kB all_unreclaimable? no
Normal free:1156kB min:1156kB low:1444kB high:1732kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:80160kB writepending:0kB present:131072kB managed:83676kB mlocked:0kB kernel_stack:136kB pagetables:0kB bounce:0kB free_pcp:8kB local_pcp:8kB free_cma:0kB
lowmem_reserve[]: 0 0
Normal: 1*4kB (U) 2*8kB (UM) 3*16kB (UM) 2*32kB (UM) 2*64kB (UM) 1*128kB (U) 1*256kB (M) 1*512kB (U) 0*1024kB 0*2048kB 0*4096kB = 1156kB
20042 total pagecache pages
0 pages in swap cache
Swap cache stats: add 0, delete 0, find 0/0
Free swap  = 0kB
Total swap = 0kB
32768 pages RAM
0 pages HighMem/MovableOnly
11849 pages reserved
0 pages cma reserved
Tasks state (memory values in pages):
[  pid  ]   uid  tgid total_vm      rss pgtables_bytes swapents oom_score_adj name
Out of memory and no killable processes...
Kernel panic - not syncing: System is deadlocked on memory

CPU: 0 PID: 1 Comm: swapper Not tainted 4.19.0 #2
Hardware name: ARM-Versatile (Device Tree Support)
[<c001c7f4>] (unwind_backtrace) from [<c001949c>] (show_stack+0x10/0x14)
[<c001949c>] (show_stack) from [<c0024ee4>] (panic+0xc8/0x248)
[<c0024ee4>] (panic) from [<c0083b7c>] (out_of_memory+0x424/0x460)
[<c0083b7c>] (out_of_memory) from [<c00889c8>] (__alloc_pages_nodemask+0xaa8/0xc00)
[<c00889c8>] (__alloc_pages_nodemask) from [<c007fd00>] (pagecache_get_page+0x200/0x310)
[<c007fd00>] (pagecache_get_page) from [<c007fe28>] (grab_cache_page_write_begin+0x18/0x2c)
[<c007fe28>] (grab_cache_page_write_begin) from [<c00e9b40>] (simple_write_begin+0x1c/0x124)
[<c00e9b40>] (simple_write_begin) from [<c007f554>] (generic_perform_write+0xb8/0x1c8)
[<c007f554>] (generic_perform_write) from [<c0082224>] (__generic_file_write_iter+0x184/0x1e8)
[<c0082224>] (__generic_file_write_iter) from [<c00823a4>] (generic_file_write_iter+0x11c/0x214)
[<c00823a4>] (generic_file_write_iter) from [<c00c5e80>] (__vfs_write+0xf8/0x164)
[<c00c5e80>] (__vfs_write) from [<c00c6088>] (vfs_write+0xa0/0x178)
[<c00c6088>] (vfs_write) from [<c00c62c8>] (ksys_write+0x50/0xb8)
[<c00c62c8>] (ksys_write) from [<c050d888>] (xwrite+0x2c/0x68)
[<c050d888>] (xwrite) from [<c050db48>] (do_copy+0xb4/0x104)
[<c050db48>] (do_copy) from [<c050d494>] (write_buffer+0x2c/0x44)
[<c050d494>] (write_buffer) from [<c050d4e4>] (flush_buffer+0x38/0xa0)
[<c050d4e4>] (flush_buffer) from [<c0527d10>] (__gunzip+0x288/0x364)
[<c0527d10>] (__gunzip) from [<c0527e10>] (gunzip+0x24/0x2c)
[<c0527e10>] (gunzip) from [<c050e038>] (unpack_to_rootfs+0x16c/0x2b4)
[<c050e038>] (unpack_to_rootfs) from [<c050e1d4>] (populate_rootfs+0x54/0x118)
[<c050e1d4>] (populate_rootfs) from [<c000ac18>] (do_one_initcall+0x48/0x1a8)
[<c000ac18>] (do_one_initcall) from [<c050bdd0>] (kernel_init_freeable+0x108/0x1d0)
[<c050bdd0>] (kernel_init_freeable) from [<c03e6f78>] (kernel_init+0x8/0xf4)
[<c03e6f78>] (kernel_init) from [<c00090e0>] (ret_from_fork+0x14/0x34)
Exception stack(0xc781dfb0 to 0xc781dff8)
dfa0:                                     00000000 00000000 00000000 00000000
dfc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
dfe0: 00000000 00000000 00000000 00000000 00000013 00000000
Rebooting in 1 seconds..
Reboot failed -- System halted
```


### case 5
```
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-

qemu-system-arm \
  -M versatilepb \
  -m 256 \
  -dtb    linux/arch/arm/boot/dts/versatile-pb.dtb \
  -kernel linux/arch/arm/boot/zImage   \
  -initrd linux/arch/arm/boot/initrd.img \
  -append 'root=/dev/ram0 -hda kernel-qemu-4.19.50-buster panic=1 rootfstype=ext4 rw' \
  -no-reboot \
  -nographic

<log>  

pulseaudio: set_sink_input_volume() failed
pulseaudio: Reason: Invalid argument
pulseaudio: set_sink_input_mute() failed
pulseaudio: Reason: Invalid argument
vpb_sic_write: Bad register offset 0x2c
Booting Linux on physical CPU 0x0
Linux version 4.19.0 (good@good-VirtualBox) (gcc version 4.9.3 (crosstool-NG crosstool-ng-1.22.0-88-g8460611)) #2 Sun Jul 26 20:18:41 KST 2020
CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=00093177
CPU: VIVT data cache, VIVT instruction cache
OF: fdt: Machine model: ARM Versatile PB
Memory policy: Data cache writeback
random: get_random_bytes called from start_kernel+0x7c/0x3e8 with crng_init=0
Built 1 zonelists, mobility grouping on.  Total pages: 65024
Kernel command line: root=/dev/ram0 -hda kernel-qemu-4.19.50-buster panic=1 rootfstype=ext4 rw
Dentry cache hash table entries: 32768 (order: 5, 131072 bytes)
Inode-cache hash table entries: 16384 (order: 4, 65536 bytes)
Memory: 213628K/262144K available (3980K kernel code, 148K rwdata, 1008K rodata, 180K init, 131K bss, 48516K reserved, 0K cma-reserved)
Virtual kernel memory layout:
    vector  : 0xffff0000 - 0xffff1000   (   4 kB)
    fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
    vmalloc : 0xd0800000 - 0xff800000   ( 752 MB)
    lowmem  : 0xc0000000 - 0xd0000000   ( 256 MB)
    modules : 0xbf000000 - 0xc0000000   (  16 MB)
      .text : 0x(ptrval) - 0x(ptrval)   (3982 kB)
      .init : 0x(ptrval) - 0x(ptrval)   ( 180 kB)
      .data : 0x(ptrval) - 0x(ptrval)   ( 149 kB)
       .bss : 0x(ptrval) - 0x(ptrval)   ( 132 kB)
NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16
VIC @(ptrval): id 0x00041190, vendor 0x41
FPGA IRQ chip 0 "intc" @ (ptrval), 20 irqs, parent IRQ: 47
clocksource: arm,sp804: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 1911260446275 ns
sched_clock: 32 bits at 1000kHz, resolution 1000ns, wraps every 2147483647500ns
Failed to initialize '/amba/timer@101e3000': -22
sched_clock: 32 bits at 24MHz, resolution 41ns, wraps every 89478484971ns
Console: colour dummy device 80x30
console [tty0] enabled
Calibrating delay loop... 638.97 BogoMIPS (lpj=3194880)
pid_max: default: 32768 minimum: 301
Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
CPU: Testing write buffer coherency: ok
Setting up static identity map for 0x8400 - 0x8458
VFP support v0.3: implementor 41 architecture 1 part 10 variant 9 rev 0
clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
futex hash table entries: 256 (order: -1, 3072 bytes)
NET: Registered protocol family 16
DMA: preallocated 256 KiB pool for atomic coherent allocations
OF: amba_device_add() failed (-19) for /amba/smc@10100000
OF: amba_device_add() failed (-19) for /amba/mpmc@10110000
OF: amba_device_add() failed (-19) for /amba/sctl@101e0000
OF: amba_device_add() failed (-19) for /amba/watchdog@101e1000
OF: amba_device_add() failed (-19) for /amba/sci@101f0000
OF: amba_device_add() failed (-19) for /amba/ssp@101f4000
OF: amba_device_add() failed (-19) for /amba/fpga/sci@a000
Serial: AMBA PL011 UART driver
101f1000.uart: ttyAMA0 at MMIO 0x101f1000 (irq = 28, base_baud = 0) is a PL011 rev1
console [ttyAMA0] enabled
101f2000.uart: ttyAMA1 at MMIO 0x101f2000 (irq = 29, base_baud = 0) is a PL011 rev1
101f3000.uart: ttyAMA2 at MMIO 0x101f3000 (irq = 30, base_baud = 0) is a PL011 rev1
uart-pl011 10009000.uart: aliased and non-aliased serial devices found in device tree. Serial port enumeration may be unpredictable.
10009000.uart: ttyAMA3 at MMIO 0x10009000 (irq = 54, base_baud = 0) is a PL011 rev1
clocksource: Switched to clocksource arm,sp804
NET: Registered protocol family 2
tcp_listen_portaddr_hash hash table entries: 512 (order: 0, 4096 bytes)
TCP established hash table entries: 2048 (order: 1, 8192 bytes)
TCP bind hash table entries: 2048 (order: 1, 8192 bytes)
TCP: Hash tables configured (established 2048 bind 2048)
UDP hash table entries: 256 (order: 0, 4096 bytes)
UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)
NET: Registered protocol family 1
RPC: Registered named UNIX socket transport module.
RPC: Registered udp transport module.
RPC: Registered tcp transport module.
RPC: Registered tcp NFSv4.1 backchannel transport module.
Trying to unpack rootfs image as initramfs...
random: fast init done
Freeing initrd memory: 40544K
NetWinder Floating Point Emulator V0.97 (double precision)
workingset: timestamp_bits=30 max_order=16 bucket_order=0
Installing knfsd (copyright (C) 1996 okir@monad.swb.de).
jffs2: version 2.2. (NAND) © 2001-2006 Red Hat, Inc.
romfs: ROMFS MTD (C) 2007 Red Hat, Inc.
Block layer SCSI generic (bsg) driver version 0.4 loaded (major 252)
io scheduler noop registered
io scheduler deadline registered
io scheduler cfq registered (default)
io scheduler mq-deadline registered
io scheduler kyber registered
pl061_gpio 101e4000.gpio: PL061 GPIO chip @0x101e4000 registered
pl061_gpio 101e5000.gpio: PL061 GPIO chip @0x101e5000 registered
pl061_gpio 101e6000.gpio: PL061 GPIO chip @0x101e6000 registered
pl061_gpio 101e7000.gpio: PL061 GPIO chip @0x101e7000 registered
versatile-tft-panel 10000000.sysreg:display@0: no panel detected
drm-clcd-pl111 dev:20: set up callbacks for Versatile PL110
drm-clcd-pl111 dev:20: found bridge on endpoint 1
drm-clcd-pl111 dev:20: Using non-panel bridge
[drm] Supports vblank timestamp caching Rev 2 (21.10.2013).
[drm] No driver support for vblank timestamp query.
drm-clcd-pl111 dev:20: enable Versatile CLCD connectors
Console: switching to colour frame buffer device 100x75
drm-clcd-pl111 dev:20: fb0: DRM emulated frame buffer device
[drm] Initialized pl111 1.0.0 20170317 for dev:20 on minor 0
brd: module loaded
of-flash 34000000.flash: versatile/realview flash protection
34000000.flash: Found 1 x32 devices at 0x0 in 32-bit bank. Manufacturer ID 0x000000 Chip ID 0x000000
Intel/Sharp Extended Query Table at 0x0031
Using buffer write method
request_module: kmod_concurrent_max (0) close to 0 (max_modprobes: 50), for module binfmt-464c, throttling...
request_module: modprobe binfmt-464c cannot be processed, kmod busy with 50 threads for more than 5 seconds now
smc91x.c: v1.1, sep 22 2004 by Nicolas Pitre <nico@fluxnic.net>
smc91x 10010000.net eth0: SMC91C11xFD (rev 1) at (ptrval) IRQ 41
smc91x 10010000.net eth0: Ethernet addr: 52:54:00:12:34:56
rtc-ds1307 0-0068: registered as rtc0
versatile reboot driver registered
mmci-pl18x fpga:05: mmc0: PL181 manf 41 rev0 at 0x10005000 irq 59,60 (pio)
mmci-pl18x fpga:0b: mmc1: PL181 manf 41 rev0 at 0x1000b000 irq 49,50 (pio)
leds-syscon 10000000.core-module:led@08.0: registered LED versatile:0
leds-syscon 10000000.core-module:led@08.1: registered LED versatile:1
leds-syscon 10000000.core-module:led@08.2: registered LED versatile:2
leds-syscon 10000000.core-module:led@08.3: registered LED versatile:3
leds-syscon 10000000.core-module:led@08.4: registered LED versatile:4
leds-syscon 10000000.core-module:led@08.5: registered LED versatile:5
leds-syscon 10000000.core-module:led@08.6: registered LED versatile:6
leds-syscon 10000000.core-module:led@08.7: registered LED versatile:7
ledtrig-cpu: registered to indicate activity on CPUs
NET: Registered protocol family 17
rtc-ds1307 0-0068: setting system clock to 2020-07-26 12:36:26 UTC (1595766986)
Freeing unused kernel memory: 180K
This architecture does not have kernel memory protection.
Run /init as init process
input: AT Raw Set 2 keyboard as /devices/platform/amba/amba:fpga/10006000.kmi/serio0/input/input0
request_module: kmod_concurrent_max (0) close to 0 (max_modprobes: 50), for module binfmt-464c, throttling...
input: ImExPS/2 Generic Explorer Mouse as /devices/platform/amba/amba:fpga/10007000.kmi/serio1/input/input2
request_module: modprobe binfmt-464c cannot be processed, kmod busy with 50 threads for more than 5 seconds now
request_module: kmod_concurrent_max (0) close to 0 (max_modprobes: 50), for module binfmt-464c, throttling...
request_module: modprobe binfmt-464c cannot be processed, kmod busy with 50 threads for more than 5 seconds now
Failed to execute /init (error -8)
Run /sbin/init as init process
Run /etc/init as init process
Run /bin/init as init process
Run /bin/sh as init process
request_module: kmod_concurrent_max (0) close to 0 (max_modprobes: 50), for module binfmt-464c, throttling...
request_module: modprobe binfmt-464c cannot be processed, kmod busy with 50 threads for more than 5 seconds now
Starting init: /bin/sh exists but couldn't execute it (error -8)
Kernel panic - not syncing: No working init found.  Try passing init= option to kernel. See Linux Documentation/admin-guide/init.rst for guidance.
CPU: 0 PID: 1 Comm: swapper Not tainted 4.19.0 #2
Hardware name: ARM-Versatile (Device Tree Support)
[<c001c7f4>] (unwind_backtrace) from [<c001949c>] (show_stack+0x10/0x14)
[<c001949c>] (show_stack) from [<c0024ee4>] (panic+0xc8/0x248)
[<c0024ee4>] (panic) from [<c03e703c>] (kernel_init+0xcc/0xf4)
[<c03e703c>] (kernel_init) from [<c00090e0>] (ret_from_fork+0x14/0x34)
Exception stack(0xcf821fb0 to 0xcf821ff8)
1fa0:                                     00000000 00000000 00000000 00000000
1fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
1fe0: 00000000 00000000 00000000 00000000 00000013 00000000
Rebooting in 1 seconds..

```

### case 6
```
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-

qemu-system-arm \
  -M versatilepb \
  -m 256 \
  -dtb    linux/arch/arm/boot/dts/versatile-pb.dtb \
  -kernel linux/arch/arm/boot/zImage   \
  -initrd linux/arch/arm/boot/initrd.img \
  -append "root=/dev/vda2 rw console=ttyAMA0 initrd=/bin/sh" \
  -hda 2020-02-13-raspbian-buster.img\
  -net user,hostfwd=tcp::5022-:22 \
  -no-reboot \
  -nographic
  
<log >
WARNING: Image format was not specified for '2020-02-13-raspbian-buster.img' and probing guessed raw.
         Automatically detecting the format is dangerous for raw images, write operations on block 0 will be restricted.
         Specify the 'raw' format explicitly to remove the restrictions.
pulseaudio: set_sink_input_volume() failed
pulseaudio: Reason: Invalid argument
pulseaudio: set_sink_input_mute() failed
pulseaudio: Reason: Invalid argument
qemu-system-arm: warning: hub 0 with no nics
vpb_sic_write: Bad register offset 0x2c
Booting Linux on physical CPU 0x0
Linux version 4.19.0 (good@good-VirtualBox) (gcc version 4.9.3 (crosstool-NG crosstool-ng-1.22.0-88-g8460611)) #2 Sun Jul 26 20:18:41 KST 2020
CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=00093177
CPU: VIVT data cache, VIVT instruction cache
OF: fdt: Machine model: ARM Versatile PB
Memory policy: Data cache writeback
random: get_random_bytes called from start_kernel+0x7c/0x3e8 with crng_init=0
Built 1 zonelists, mobility grouping on.  Total pages: 65024
Kernel command line: root=/dev/vda2 rw console=ttyAMA0 initrd=/bin/sh
Dentry cache hash table entries: 32768 (order: 5, 131072 bytes)
Inode-cache hash table entries: 16384 (order: 4, 65536 bytes)
Memory: 213628K/262144K available (3980K kernel code, 148K rwdata, 1008K rodata, 180K init, 131K bss, 48516K reserved, 0K cma-reserved)
Virtual kernel memory layout:
    vector  : 0xffff0000 - 0xffff1000   (   4 kB)
    fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)
    vmalloc : 0xd0800000 - 0xff800000   ( 752 MB)
    lowmem  : 0xc0000000 - 0xd0000000   ( 256 MB)
    modules : 0xbf000000 - 0xc0000000   (  16 MB)
      .text : 0x(ptrval) - 0x(ptrval)   (3982 kB)
      .init : 0x(ptrval) - 0x(ptrval)   ( 180 kB)
      .data : 0x(ptrval) - 0x(ptrval)   ( 149 kB)
       .bss : 0x(ptrval) - 0x(ptrval)   ( 132 kB)
NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16
VIC @(ptrval): id 0x00041190, vendor 0x41
FPGA IRQ chip 0 "intc" @ (ptrval), 20 irqs, parent IRQ: 47
clocksource: arm,sp804: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 1911260446275 ns
sched_clock: 32 bits at 1000kHz, resolution 1000ns, wraps every 2147483647500ns
Failed to initialize '/amba/timer@101e3000': -22
sched_clock: 32 bits at 24MHz, resolution 41ns, wraps every 89478484971ns
Console: colour dummy device 80x30
Calibrating delay loop... 657.81 BogoMIPS (lpj=3289088)
pid_max: default: 32768 minimum: 301
Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)
Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)
CPU: Testing write buffer coherency: ok
Setting up static identity map for 0x8400 - 0x8458
VFP support v0.3: implementor 41 architecture 1 part 10 variant 9 rev 0
clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
futex hash table entries: 256 (order: -1, 3072 bytes)
NET: Registered protocol family 16
DMA: preallocated 256 KiB pool for atomic coherent allocations
OF: amba_device_add() failed (-19) for /amba/smc@10100000
OF: amba_device_add() failed (-19) for /amba/mpmc@10110000
OF: amba_device_add() failed (-19) for /amba/sctl@101e0000
OF: amba_device_add() failed (-19) for /amba/watchdog@101e1000
OF: amba_device_add() failed (-19) for /amba/sci@101f0000
OF: amba_device_add() failed (-19) for /amba/ssp@101f4000
OF: amba_device_add() failed (-19) for /amba/fpga/sci@a000
Serial: AMBA PL011 UART driver
101f1000.uart: ttyAMA0 at MMIO 0x101f1000 (irq = 28, base_baud = 0) is a PL011 rev1
console [ttyAMA0] enabled
101f2000.uart: ttyAMA1 at MMIO 0x101f2000 (irq = 29, base_baud = 0) is a PL011 rev1
101f3000.uart: ttyAMA2 at MMIO 0x101f3000 (irq = 30, base_baud = 0) is a PL011 rev1
uart-pl011 10009000.uart: aliased and non-aliased serial devices found in device tree. Serial port enumeration may be unpredictable.
10009000.uart: ttyAMA3 at MMIO 0x10009000 (irq = 54, base_baud = 0) is a PL011 rev1
clocksource: Switched to clocksource arm,sp804
NET: Registered protocol family 2
tcp_listen_portaddr_hash hash table entries: 512 (order: 0, 4096 bytes)
TCP established hash table entries: 2048 (order: 1, 8192 bytes)
TCP bind hash table entries: 2048 (order: 1, 8192 bytes)
TCP: Hash tables configured (established 2048 bind 2048)
UDP hash table entries: 256 (order: 0, 4096 bytes)
UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)
NET: Registered protocol family 1
RPC: Registered named UNIX socket transport module.
RPC: Registered udp transport module.
RPC: Registered tcp transport module.
RPC: Registered tcp NFSv4.1 backchannel transport module.
Trying to unpack rootfs image as initramfs...
random: fast init done
Freeing initrd memory: 40544K
NetWinder Floating Point Emulator V0.97 (double precision)
workingset: timestamp_bits=30 max_order=16 bucket_order=0
Installing knfsd (copyright (C) 1996 okir@monad.swb.de).
jffs2: version 2.2. (NAND) © 2001-2006 Red Hat, Inc.
romfs: ROMFS MTD (C) 2007 Red Hat, Inc.
Block layer SCSI generic (bsg) driver version 0.4 loaded (major 252)
io scheduler noop registered
io scheduler deadline registered
io scheduler cfq registered (default)
io scheduler mq-deadline registered
io scheduler kyber registered
pl061_gpio 101e4000.gpio: PL061 GPIO chip @0x101e4000 registered
pl061_gpio 101e5000.gpio: PL061 GPIO chip @0x101e5000 registered
pl061_gpio 101e6000.gpio: PL061 GPIO chip @0x101e6000 registered
pl061_gpio 101e7000.gpio: PL061 GPIO chip @0x101e7000 registered
versatile-tft-panel 10000000.sysreg:display@0: no panel detected
drm-clcd-pl111 dev:20: set up callbacks for Versatile PL110
drm-clcd-pl111 dev:20: found bridge on endpoint 1
drm-clcd-pl111 dev:20: Using non-panel bridge
[drm] Supports vblank timestamp caching Rev 2 (21.10.2013).
[drm] No driver support for vblank timestamp query.
drm-clcd-pl111 dev:20: enable Versatile CLCD connectors
Console: switching to colour frame buffer device 100x75
drm-clcd-pl111 dev:20: fb0: DRM emulated frame buffer device
[drm] Initialized pl111 1.0.0 20170317 for dev:20 on minor 0
brd: module loaded
of-flash 34000000.flash: versatile/realview flash protection
34000000.flash: Found 1 x32 devices at 0x0 in 32-bit bank. Manufacturer ID 0x000000 Chip ID 0x000000
Intel/Sharp Extended Query Table at 0x0031
Using buffer write method
request_module: kmod_concurrent_max (0) close to 0 (max_modprobes: 50), for module binfmt-464c, throttling...
request_module: modprobe binfmt-464c cannot be processed, kmod busy with 50 threads for more than 5 seconds now
smc91x: not found (-19).
rtc-ds1307 0-0068: registered as rtc0
versatile reboot driver registered
mmci-pl18x fpga:05: mmc0: PL181 manf 41 rev0 at 0x10005000 irq 59,60 (pio)
mmci-pl18x fpga:0b: mmc1: PL181 manf 41 rev0 at 0x1000b000 irq 49,50 (pio)
leds-syscon 10000000.core-module:led@08.0: registered LED versatile:0
leds-syscon 10000000.core-module:led@08.1: registered LED versatile:1
leds-syscon 10000000.core-module:led@08.2: registered LED versatile:2
leds-syscon 10000000.core-module:led@08.3: registered LED versatile:3
leds-syscon 10000000.core-module:led@08.4: registered LED versatile:4
leds-syscon 10000000.core-module:led@08.5: registered LED versatile:5
leds-syscon 10000000.core-module:led@08.6: registered LED versatile:6
leds-syscon 10000000.core-module:led@08.7: registered LED versatile:7
ledtrig-cpu: registered to indicate activity on CPUs
NET: Registered protocol family 17
rtc-ds1307 0-0068: setting system clock to 2020-07-26 13:11:18 UTC (1595769078)
Freeing unused kernel memory: 180K
This architecture does not have kernel memory protection.
Run /init as init process
input: AT Raw Set 2 keyboard as /devices/platform/amba/amba:fpga/10006000.kmi/serio0/input/input0
request_module: kmod_concurrent_max (0) close to 0 (max_modprobes: 50), for module binfmt-464c, throttling...
input: ImExPS/2 Generic Explorer Mouse as /devices/platform/amba/amba:fpga/10007000.kmi/serio1/input/input2
request_module: modprobe binfmt-464c cannot be processed, kmod busy with 50 threads for more than 5 seconds now
request_module: kmod_concurrent_max (0) close to 0 (max_modprobes: 50), for module binfmt-464c, throttling...
request_module: modprobe binfmt-464c cannot be processed, kmod busy with 50 threads for more than 5 seconds now
Failed to execute /init (error -8)
Run /sbin/init as init process
Run /etc/init as init process
Run /bin/init as init process
Run /bin/sh as init process
request_module: kmod_concurrent_max (0) close to 0 (max_modprobes: 50), for module binfmt-464c, throttling...
request_module: modprobe binfmt-464c cannot be processed, kmod busy with 50 threads for more than 5 seconds now
Starting init: /bin/sh exists but couldn't execute it (error -8)
Kernel panic - not syncing: No working init found.  Try passing init= option to kernel. See Linux Documentation/admin-guide/init.rst for guidance.
CPU: 0 PID: 1 Comm: swapper Not tainted 4.19.0 #2
Hardware name: ARM-Versatile (Device Tree Support)
[<c001c7f4>] (unwind_backtrace) from [<c001949c>] (show_stack+0x10/0x14)
[<c001949c>] (show_stack) from [<c0024ee4>] (panic+0xc8/0x248)
[<c0024ee4>] (panic) from [<c03e703c>] (kernel_init+0xcc/0xf4)
[<c03e703c>] (kernel_init) from [<c00090e0>] (ret_from_fork+0x14/0x34)
Exception stack(0xcf821fb0 to 0xcf821ff8)
1fa0:                                     00000000 00000000 00000000 00000000
1fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
1fe0: 00000000 00000000 00000000 00000000 00000013 00000000
---[ end Kernel panic - not syncing: No working init found.  Try passing init= option to kernel. See Linux Documentation/admin-guide/init.rst for guidance. ]---
random: crng init done
```




### case 6 
```
$ cat run.sh
qemu-system-arm \
  -M versatilepb \
  -cpu arm1176 \
  -m 256 \
  -hda  2020-02-13-raspbian-buster-lite.img \
  -net nic, \
  -net user,hostfwd=tcp::5022-:22 \
  -dtb versatile-pb.dtb \
  -kernel kernel-qemu-4.19.50-buster \
  -append 'root=/dev/sda2 panic=1' \
  -no-reboot \
  -nographic
  ```

### case 7  Versatilepb  arm1176 raspbian-buster
<https://github.com/dhruvvyas90/qemu-rpi-kernel/blob/master/README.md>
```
$ cat run4.sh
qemu-system-arm \
  -M versatilepb \
  -cpu arm1176 \
  -m 256 \
  -hda  2020-02-13-raspbian-buster-lite.img \
  -dtb versatile-pb.dtb \
  -kernel kernel-qemu-4.19.50-buster  \
  -append 'root=/dev/sda2 panic=1' \
  -no-reboot \
  -nographic
==> booting
```


# qemu-rpi-kernel

[참고] <https://rderik.com/blog/running-raspbian-os-on-quemu-to-learn-arm-assembly/>

### get resource
```
$ git clone https://github.com/dhruvvyas90/qemu-rpi-kernel.git
$ curl -JLO https://downloads.raspberrypi.org/raspbian_lite_latest
$ curl -sI  https://downloads.raspberrypi.org/raspbian_lite_lates
$ curl -O `curl https://downloads.raspberrypi.org/raspbian_lite_latest -s -L -I -o /dev/null -w '%{url_effective}'`
$ mv raspbian_lite_latest 2019-09-26-raspbian-buster-lite.zip
$ unzip 2019-09-26-raspbian-buster-lite.zip
$ tree.
├── 2020-02-13-raspbian-buster-lite.img
├── README.md
├── kernel-qemu-3.10.25-wheezy
├── kernel-qemu-4.14.79-stretch
├── kernel-qemu-4.19.50-buster
├── kernel-qemu-4.4.34-jessie
├── raspbian_lite_latest
├── run.sh
├── tools
│   ├── README.md
│   ├── build-kernel-qemu
│   ├── build-kernel-qemu.conf-4.14.79
│   ├── config_file
│   ├── config_file_3.10.25
│   ├── config_file_4.19.50
│   ├── config_file_4.4.34
│   ├── config_ip_tables
│   ├── config_loopdev
│   ├── config_webcam
│   ├── linux-arm-4.4.34.patch
│   ├── linux-arm.patch
│   └── qemu_choose_vm.sh
├── versatile-pb-buster.dtb
└── versatile-pb.dtb
## Obtaining Raspbian

### Choosing a kernel image

This repository contains three types of kernel images:

* `kernel-qemu-4.*.*-buster` are the most recent images, which are compatible with Raspbian Buster and Stretch. To use these images, you'll need a compiled device tree file (.dtb) which is also contained in this repository.  Use `versatile-pb-buster.dtb` for Buster, or use `versatile-pb.dtb` for Stretch. Unless you are positive you need a different kernel, the most recent of these images is probably what you want.

* `kernel-qemu-4.*.*-stretch` are images compatible with Raspbian Stretch and Jessie. To use these images, you'll need the `versatile-pb.dtb` file which is also contained in this repository.

* `kernel-qemu-4.4.*-jessie` are images compatible with Raspbian Jessie and Wheezy.

* `kernel-qemu-3.10.25-wheezy` is the original image from [xecdesign.com], which is compatible with Raspbian Wheezy only.

### Using kernel images with QEMU

The QEMU command line will look like
```
    $ qemu-system-arm \
      -M versatilepb \
      -cpu arm1176 \
      -m 256 \
      -hda /.../2019-09-26-raspbian-buster-lite.img \
      -net user,hostfwd=tcp::5022-:22 \
      -dtb /.../versatile-pb-buster.dtb \
      -kernel /.../kernel-qemu-4.19.50-buster \
      -append 'root=/dev/sda2 panic=1' \
      -no-reboot
```
with the paths to the disk image, `.dtb` file and kernel image adjusted appropriately.
There is a Docker image available to automate this whole process:
```

### Building your own kernel image

See the contents of the `tools/` directory, where the build scripts and instructions on how to use them are stored.

```
$ cat build-kernel-qemu
#!/bin/bash -e
#
# Build ARM kernel 4.x.y for QEMU Raspberry Pi Emulation
#
#######################################################

TOOLCHAIN=arm-linux-gnueabihf
COMMIT=raspberrypi-kernel_1.20190620-1
INSTALL_PACKAGES=""
USE_GIT=1
USB_WEBCAM_MODULES=""    # add USB & V4L modules for USB webcam support (didn't work as static)
KERNEL_MAKE_CONFIG=menuconfig # set to olddefconfig to skip user prompting
KERNEL_EXTRA_CONFIG=""

SOURCE_DIR=$(pwd)
BUILD_DIR=$SOURCE_DIR
TARGET_DIR=$SOURCE_DIR

if [ -f build-kernel-qemu.conf ] ; then
	. build-kernel-qemu.conf
fi

if [ "$INSTALL_PACKAGES" ] ; then
	sudo apt-get update
	sudo apt-get install git libncurses5-dev gcc-arm-linux-gnueabihf flex bison
fi

mkdir -p $BUILD_DIR $TARGET_DIR
CUR_DIR=$(pwd)
cd $BUILD_DIR

if [ "$USE_GIT" ] ; then
	# checking out 4.x.y tag - change it if you want to change kernel version
	# for a specific hash, have a look at: https://github.com/raspberrypi/linux/tags
	# To check the effective kernel version, click on a tag in that list;
	# the branch and tag name are under the commit message.
	if [ ! -d linux ] ; then
		git clone https://github.com/raspberrypi/linux.git
	else
		echo "Using existing Linux sources!"
	fi
	cd linux
	if [ "$COMMIT" ] ; then
		git reset --hard
		git clean -xdf
		git checkout "$COMMIT"
	fi
else
	if [ -z "$COMMIT" ] ; then echo "COMMIT missing!" >&2 ; exit 1 ; fi
	wget -c https://github.com/raspberrypi/linux/archive/${COMMIT}.zip -O linux-${COMMIT}.zip
	rm -rf linux-${COMMIT}
	unzip linux-${COMMIT}.zip
	cd linux-${COMMIT}
fi

# Use all available cores for compilation
export MAKEFLAGS="$MAKEFLAGS -j$(nproc)"

KERNEL_VERSION=$(make kernelversion)
KERNEL_TARGET_FILE_NAME=$TARGET_DIR/qemu-kernel-$KERNEL_VERSION
MODULES_INSTALL_PATH=$TARGET_DIR/qemu-kernel-$KERNEL_VERSION-modules
if [ -e "../linux-arm-$KERNEL_VERSION.patch" ]; then
    patch -p1 < $SOURCE_DIR/linux-arm-$KERNEL_VERSION.patch
else
    patch -p1 < $SOURCE_DIR/linux-arm.patch
fi
make ARCH=arm versatile_defconfig
echo "Building Qemu Raspberry Pi kernel qemu-kernel-$KERNEL_VERSION"

cat >> .config << EOF
CONFIG_CROSS_COMPILE="$TOOLCHAIN"
EOF

if [ -e "$SOURCE_DIR/config_file_$KERNEL_VERSION" ]; then
    cat "$SOURCE_DIR/config_file_$KERNEL_VERSION" >> .config
else
    cat "$SOURCE_DIR/config_file" >> .config
fi

if [ -e "$KERNEL_EXTRA_CONFIG" ]; then
    cat "$KERNEL_EXTRA_CONFIG" >> .config
fi

if [ $USB_WEBCAM_MODULES ] ; then
    echo "Make sure you have drivers for your webcam selected in menuconfig"
    cat $SOURCE_DIR/config_webcam >> .config
fi

cat $SOURCE_DIR/config_ip_tables >> .config
cat $SOURCE_DIR/config_loopdev >> .config

make -k ARCH=arm CROSS_COMPILE=${TOOLCHAIN}- $KERNEL_MAKE_CONFIG
make -k ARCH=arm CROSS_COMPILE=${TOOLCHAIN}- bzImage dtbs
cp arch/arm/boot/zImage $KERNEL_TARGET_FILE_NAME
if [ -e arch/arm/boot/dts/versatile-pb.dtb ] ; then
    cp arch/arm/boot/dts/versatile-pb.dtb $TARGET_DIR
fi

if [ $USB_WEBCAM_MODULES ] ; then
    mkdir -p $MODULES_INSTALL_PATH
    if [ ! -d $MODULES_INSTALL_PATH ] ; then
        echo "Couldn't create webcam modules install directory $MODULES_INSTALL_PATH"
    fi
    make -k ARCH=arm CROSS_COMPILE=${TOOLCHAIN}- modules
    make -k ARCH=arm CROSS_COMPILE=${TOOLCHAIN}- \
        INSTALL_MOD_PATH=$MODULES_INSTALL_PATH modules_install
    echo "Copy modules to Raspberry to /lib/modules/$KERNEL_VERSION"
fi

cd $CUR_DIR

```



## Origin of this repository

While searching the Internet for information on emulating a Raspberry Pi using
QEMU in Jun 2015, most of the guides pointed to kernel images hosted on
[xecdesign.com]; however, at the time the resource was no longer online, and
that's still the case as of Feb 2019.

This repository was initially created as a way to make those kernel images
available once again, and has since been expanded to provide improved and
up-to-date images.

## Further information

Additional documentation can be found on the [wiki].

[Raspbian image]: https://www.raspberrypi.org/downloads/raspbian/
[kernel sources]: https://github.com/raspberrypi/linux/
[xecdesign.com]: https://xecdesign.com/downloads/linux-qemu/kernel-qemu
[wiki]: https://github.com/dhruvvyas90/qemu-rpi-kernel/wiki




## install package
```
$ sudo apt-get install git libncurses5-dev gcc-arm-linux-gnueabihf
$ sudo apt-get install ia32-libs
```
### preparing the kernel
```
$ git clone https://github.com/raspberrypi/linux.git
The  kernel does not have support for ARM11(ARMv6) for the Versatile board, so we will need to download and apply a patch.
$ wget http://xecdesign.com/downloads/linux-qemu/linux-arm.patch
$ patch -p1 -d linux/ < linux-arm.patch
```

1. cd linux
2. make ARCH=arm versatile_defconfig
3. make ARCH=arm menuconfig

### .config
```
Specify the cross-compiler:
  General Setup --->
    Cross-compiler tool prefix (arm-linux-gnueabihf-)

Select the right CPU options:
  System Type --->
  [*] Support ARM V6 processor
  [*] ARM errata: Invalidation of the Instruction Cache operation can fail
  [*] ARM errata: Possible cache data corruption with hit-under-miss enabled

Enable support for hard-float binaries:
  Floating point emulation  --->
  [*] VFP-format floating point maths

Enable ARM EABI:
  Kernel Features --->
  [*] Use ARM EABI to compile the kernel
  [*] Allow old ABI binaries to run with this kerne  

Enable devtmpfs:
  Device Drivers --->
  Generic Driver Options--->
    [*] Maintain a devtmpfs filesystem to mount at /dev
    [*] Automount devtmpfs at /dev, after the kernel mounted the root

Enable QEMU's disk support:
  Bus Support --->
    [*] PCI Support
  Device Drivers --->
  SCSI Device Support --->
    [*] SCSI Device Support
    [*] SCSI Disk Support
    [*] SCSI CDROM support
    [*] SCSI low-lever drivers --->
    [*] SYM53C8XX  Version 2 SCSI support

Enable the important file systems:
  <*> Ext3 journalling file system support
  <*> The Extended 4 (ext4) filesystem

Enable tmpfs:
  File systems --->
  Pseudo filesystems--->
    [*] Virtual memory file system support (former shm fs)

Enable the event interface:
  Device Drivers --->
  Input device support--->
    [*] Event interface

Enable /proc/config.gz:
  General Setup --->
    [*] Kernel .config support
    [*] Enable access to .config through /proc/config.gz

Boot options:
-*- Flattened Device Tree support 
[*] Use appended device tree blob to zImage (EXPERIMENTAL)
[*]   Supplement the appended DTB with traditional ATAG information
        Kernel command line type (Use bootloader kernel arguments if available)  --->(root=1f03 mem=32M) Default kernel command string                                    
      Kernel command line type (Use bootloader kernel arguments if available)  --->

Kernel Hacking : source Disassembling
  [*] Compile the kernel with debug info 
  [*]   Generate dwarf4 debuginfo                           
  [*]   Provide GDB scripts for kernel debugging            
  [*] Enable __deprecated logic                             
  [*] Enable __must_check logic                             
  (1024) Warn for stack frames larger than (needs gcc 4.4)  
  [*] Strip assembler-generated symbols during link         
  [*] Generate readable assembler code  

```

https://github.com/dhruvvyas90/qemu-rpi-kernel/tree/master/tools

https://raw.githubusercontent.com/dhruvvyas90/qemu-rpi-kernel/master/tools/config_file_4.19.50



