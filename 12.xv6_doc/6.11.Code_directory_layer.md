## Code Directory Layer

디렉토리는 파일처럼 내부적으로 구현됩니다. 

inode의 유형은 T_DIR이고 데이터는 일련의 디렉토리 항목입니다. 

각 항목은 이름과 inode 번호를 포함하는 struct dirent입니다. 

이름은 최대 DIRSIZ(14)자입니다. 더 짧으면 NUL(0) 바이트로 종료됩니다. inode 번호가 0인 디렉토리 항목은 free입니다.



dirlookup(5361) 함수는 디렉토리에서 주어진 이름을 가진 항목을 검색합니다. 하나를 찾으면 잠금 해제된 해당 inode에 대한 포인터를 반환하고 호출자가 편집하려는 경우 *poff를 디렉토리 내 항목의 바이트 오프셋으로 설정합니다. dirlookup이 올바른 이름을 가진 항목을 찾으면 *poff를 업데이트하고 블록을 해제하고 iget을 통해 얻은 잠금 해제된 inode를 반환합니다. Dirlookup은 iget이 잠금 해제된 inode를 반환하는 이유입니다. 호출자가 dp를 잠갔으므로 조회가 ., 현재 디렉토리의 별칭인 경우 반환하기 전에 inode를 잠그려고 시도하면 dp와 교착 상태를 다시 잠그려고 시도합니다. (여러 프로세스와 .., 상위 디렉터리에 대한 별칭을 포함하는 더 복잡한 교착 상태 시나리오가 있습니다. .만이 유일한 문제는 아닙니다.) 호출자는 dp를 잠금 해제한 다음 ip를 잠글 수 있으므로 한 번에 하나의 잠금만 유지합니다.
dirlink(5402) 함수는 주어진 이름과 inode 번호를 가진 새 디렉토리 항목을 디렉토리 dp에 씁니다. 이름이 이미 있는 경우 dirlink는 오류(5408-5412)를 반환합니다. 메인 루프는 할당되지 않은 항목을 찾는 디렉토리 항목을 읽습니다. 하나를 찾으면 루프를 일찍 중지하고(5372-5373), 오프셋은 사용 가능한 항목의 오프셋으로 설정됩니다. 그렇지 않으면 루프는 dp->size로 설정된 off로 끝납니다. 어느 쪽이든 dirlink는 offset off(5422-5425)에 작성하여 디렉토리에 새 항목을 추가합니다.

