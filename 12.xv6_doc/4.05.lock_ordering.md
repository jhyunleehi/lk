## 잠금 Ordering

커널을 통한 코드 경로가 여러 잠금을 해제해야 하는 경우 모든 코드 경로가 동일한 순서로 잠금을 획득하는 것이 중요합니다. 그렇지 않으면 교착 상태의 위험이 있습니다.
xv6의 두 코드 경로에 잠금 A와 B가 필요하지만 코드 경로 1은 A와 B 순서로 잠금을 획득하고 다른 코드는 B와 A 순서로 잠금을 획득한다고 가정해 보겠습니다.
코드 경로 1이 잠금 A를 획득하고 잠금 B를 획득하기 전에 코드 경로 2가 잠금 B를 획득할 수 있기 때문에 이 상황은 교착 상태를 초래할 수 있습니다.
이제 코드 경로 1은 코드 경로 2가 보유하는 잠금 B가 필요하고 코드 경로 2는 코드 경로 1이 보유하는 잠금 A가 필요하기 때문에 두 코드 경로 모두 진행할 수 없습니다.
이러한 교착 상태를 방지하려면 모든 코드 경로가 동일한 순서로 잠금을 획득해야 합니다. 교착 상태 방지는 잠금이 함수 사양의 일부여야 하는 이유를 보여주는 또 다른 예입니다. 호출자는 함수가 동일한 순서로 잠금을 획득할 수 있도록 일관된 순서로 함수를 호출해야 합니다.

xv6은 거친 잠금을 사용하고 xv6은 단순하기 때문에 xv6에는 잠금 순서 체인이 거의 없습니다. 가장 긴 사슬은 2개의 깊이에 불과합니다. 예를 들어, ideintr은 ptable 잠금을 획득하는 wakeup을 호출하는 동안 ide 잠금을 유지합니다. 수면과 기상과 관련된 다른 많은 예가 있습니다. 이러한 순서는 5장에서 논의한 것처럼 sleep과 wakeup이 복잡한 불변성을 갖기 때문에 발생합니다. 파일 시스템에는 예를 들어 디렉토리에 대한 잠금을 획득해야 하고 상위 디렉토리에서 파일의 링크를 올바르게 해제하려면 해당 디렉토리의 파일을 잠급니다. Xv6은 항상 첫 번째 상위 디렉토리의 잠금을 획득한 다음 파일의 잠금을 획득합니다.