# Synchronization: Race Conditions, Critical Section, Locks & Unlocks



## 문제

생각해봅시다. single core cpu 상황에서...

공유 변수 count=5가 있을때 2개의 프로그램이 각각 수행될 때 결과는 얼마가 될까?

각각 1회씩 실행 했다면 결과는 5가 될 것으로 예상할 수 있다. 





#### 1. 공유 변수 사용하는 프로그램

<img src="img/image-20220119173838629.png" alt="image-20220119173838629" style="zoom:80%;" />





##### 예상 결과는 

* 순차적으로 스케쥴링 된다면 결과는 5가 될텐데...
* 불행하게도 4 와 6도 될 수 있다.  

<img src="img/image-20220119183331024.png" alt="image-20220119183331024" style="zoom:80%;" />



##### Context Switching 관점의 instruction 

* counter  주소에서 R1 레지스터에 로딩하고
* R1 레지스터에 R1+1
* counter 주소에 R1 값을 저장하는 instruction 

<img src="img/image-20220119183357281.png" alt="image-20220119183357281" style="zoom:80%;" />





#### 2. Instruction 수행 중 interrupt (Context Switching 발생)

* C언어 한 라인이 원자성을 보장되지 않는다.
* 작업이 완료되기전에 interrupt 허용될때 발생 가능한 현상

<img src="img/image-20220119183440450.png" alt="image-20220119183440450" style="zoom:80%;" />







##### 오류 발생 유형들

* context switching 발생 위치에 따라서 결과 값이 달라 진다. 

<img src="img/image-20220119183548258.png" alt="image-20220119183548258" style="zoom: 80%;" />







### Race Conditions 

#### 1. 공유 자원에 대한  경쟁 상황 

* Critical Section :  여러 프로세스가 동일한 데이터에 접근하여 조작하는 상황  
* 결과는 액세스가 발생하는 순서에 따라 다릅니다.
* Prevent race condtions by synchronization 
  * Ensure only one process at a time manipulates the critical data 
  * 공유 영역인 Critical section에 대해서는 하나만 접근하여 완료될 수 있도록 하는 것

![image-20220119183621420](img/image-20220119183621420.png)





#### 2. Race conditions in Multicore

![image-20220119183644714](img/image-20220119183644714.png)







#### 3. Critical Section

* 모든 안전한 프로그램은 다음 요구 사항을 만족 해야 한다. 
  * **Mutual Exclustion: 상호배제** : 

    주어진 시간에 임계 섹션에 한개의 프로세스만 있을 수 있다. 

  * **Progress** : 

    Critaical section에 프로세스가 없을 때 Critical section으로의 진입을 요청하는 모든 프로세스는 지체 없이 허용되어야 함

  * **No starvation (bounded wait)** : 

    다른 프로세스가 대기하는 동안 프로세스가 임계 영역에 들어가는 횟수에는 상한선이 있습니다.





#### Locks and Unlocks

* lock(L) : acquire lock L exclusively
  * only the process with L can access the critical section
* unlock(L) : release exclusive access to lock L
  * permitting other proceses to access the critical section 

<img src="img/image-20220119183722218.png" alt="image-20220119183722218" style="zoom:80%;" />





#### Lock 고려 사항 

* 단일 instructions은 쪼개지지 (인터럽트가 발생할 수 없는) 원자적 성격이 있다.
  * `eg. add %eax, %ebx`
* Multiple instructions need to be explicityly made atomic 
  * 복수의 instruciton은  명시적으로 원자성을 갖도록 만들어야 한다. 
  * Each piece of code in the OS must be checked if they need to be atomic 
  * OS 안에서 각각의 코드들은 그것들이 원자성이 있는지 체크 해야 한다. 











# How to Implement Locking: Software Solutions

#### 1. Using Interrupts 

* simple 
  * when interrupts are disabled, context switches won't happen
* Requires privileges
  * User processess generally cannot disable interrupts
* Not suited for multicore system

![image-20220119183833162](img/image-20220119183833162.png)

#### 2. Software Solution 시도#1

* Mutual exclustion 달성
* Busy waiting - cpu 자원 소모
* 좀 뭔가 다른 대안이 필요 

![image-20220119183930933](img/image-20220119183930933.png)

#### 3. Software Solution 시도 #1

*  두개의 프로세스에서 동시에 사용할 수 있는 공통 플레그가 필요

* 가능한 방안은 프로세서 별로 플래그를 각각 구성하는 방안을 생각해 볼수 있다.  



![image-20220119184014229](img/image-20220119184014229.png)



#### 4. Software Solution 시도 #1

* Need not alternate execution in critical section 
* 상호 배제를 보장하지 못함. 

![image-20220119184042732](img/image-20220119184042732.png)

* 왜 상호 배제를 보장하지 못하는가?



![image-20220119184156624](img/image-20220119184156624.png)



![image-20220119184256765](img/image-20220119184256765.png)

![image-20220119184345282](img/image-20220119184345282.png)



![image-20220119184428874](img/image-20220119184428874.png)



![image-20220119184446092](img/image-20220119184446092.png)



![image-20220119184503731](img/image-20220119184503731.png)

![image-20220119184527499](img/image-20220119184527499.png)



![image-20220119184608868](img/image-20220119184608868.png)



#  Bakery Algorithm

![image-20220119184709445](img/image-20220119184709445.png)



![image-20220119184754752](img/image-20220119184754752.png)



![image-20220119185342428](img/image-20220119185342428.png)



![image-20220119185459495](img/image-20220119185459495.png)



![image-20220119185829493](img/image-20220119185829493.png)



![image-20220119190034801](img/image-20220119190034801.png)



![image-20220119190100181](img/image-20220119190100181.png)



![image-20220119190122424](img/image-20220119190122424.png)



![image-20220119190148111](img/image-20220119190148111.png)



# Hardware Locks: Spinlock & its Usage



![image-20220119190315403](img/image-20220119190315403.png)



![image-20220119190339067](img/image-20220119190339067.png)



![image-20220119190357309](img/image-20220119190357309.png)



![image-20220119190419448](img/image-20220119190419448.png)



![image-20220119190444288](img/image-20220119190444288.png)



![image-20220119190846180](img/image-20220119190846180.png)



![image-20220119190918068](img/image-20220119190918068.png)



![image-20220119190950228](img/image-20220119190950228.png)



![image-20220119191036971](img/image-20220119191036971.png)



![image-20220119192133380](img/image-20220119192133380.png)



![image-20220119192152565](img/image-20220119192152565.png)



![image-20220119192208070](img/image-20220119192208070.png)



![image-20220119192244169](img/image-20220119192244169.png)





![image-20220119192322162](img/image-20220119192322162.png)



![image-20220119192342492](img/image-20220119192342492.png)



# Mutexes, Thundering Herd Problem



![image-20220119192524471](img/image-20220119192524471.png)

![image-20220119192546735](img/image-20220119192546735.png)



![image-20220119192613899](img/image-20220119192613899.png)



![image-20220119192637480](img/image-20220119192637480.png)



![image-20220119192655547](img/image-20220119192655547.png)





# Semaphores



![image-20220119192737650](img/image-20220119192737650.png)

![image-20220119192808418](img/image-20220119192808418.png)

![image-20220119192834264](img/image-20220119192834264.png)



![image-20220119192854610](img/image-20220119192854610.png)



![image-20220119192911654](img/image-20220119192911654.png)



![image-20220119192937821](img/image-20220119192937821.png)

![image-20220119192957705](img/image-20220119192957705.png)

![image-20220119193015360](img/image-20220119193015360.png)